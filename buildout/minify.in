#!/usr/bin/env bash
set -e

which java >/dev/null 2>&1

cd "$(git rev-parse --show-toplevel)"
FILES="app/files"

gadd() {
	if [ ! -z "$GIT_EDITOR" ]
	then
		echo git add $@
		git add $@
	fi
}

YUI_COMPRESSOR_EXT="css js"

if which node >/dev/null 2>&1
then
	YUI_COMPRESSOR_EXT="css"
	OUT="combined.min.js"
	while IFS= read -r -d '' FN
	do
	done < <(find -s "$FILES" -type f -iname "*.js" -not -iname "$OUT" -print0) | \
	uglify-js/bin/uglifyjs -nc --unsafe --inline-script --lift-vars -o "$FILES/$OUT"
	gadd "$FILES/$OUT"
fi

for EXT in $YUI_COMPRESSOR_EXT
do
	OUT="combined.min.$EXT"
	while IFS= read -r -d '' FN
	do
		echo >&2 "Minifying $FN"
		cat "$FN"
	done < <(find -s "$FILES" -type f -iname "*.$EXT" -not -iname "$OUT" -print0) | \
	java -jar ${buildout:parts-directory}/yui-compressor/build/yuicompressor-${buildout:yui-compressor-version}.jar --type $EXT -o "$FILES/$OUT"
	gadd "$FILES/$OUT"
done

# gzip SVG files
while IFS= read -r -d '' FN
do
	SVGZ="$FN"z
	echo "gzip -9 <'$FN' >'$SVGZ'"
	gzip -9 <"$FN" >"$SVGZ"
	gadd "$SVGZ"
done < <(find "$FILES" -iname "*.svg" -print0)

